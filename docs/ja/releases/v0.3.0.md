# v0.3.0 - WebSocket Direct Communication

[English](../../en/releases/v0.3.0-en.md) | 日本語

## 概要

vimd v0.3.0 では、live-server 依存を削除し、WebSocket による直接通信を実装した。
これにより、バンドルサイズを 83% 削減し、リロード制御の柔軟性を獲得した。

## ベンチマーク

### 計測環境

- Platform: darwin arm64
- Node.js: v20.19.5
- 計測回数: 10回の平均

### サーバーパフォーマンス

| 指標 | 平均 | 最小 | 最大 |
|------|------|------|------|
| Server Startup | 1.31ms | 0.23ms | 9.38ms |
| Broadcast Latency | 0.01ms | 0.00ms | 0.04ms |

### バンドルサイズ比較

| パッケージ | サイズ |
|-----------|--------|
| live-server (v0.2.x) | 1.7MB |
| ws + polka + sirv (v0.3.0) | 284KB |
| **削減率** | **-83%** |

### 考察

- サーバー起動時間は平均 1.31ms と非常に高速
- ブロードキャストレイテンシは 0.01ms とほぼゼロ
- バンドルサイズは 1.7MB から 284KB へ 83% 削減
- npm install 時間の短縮、ディスク使用量の削減に貢献

## アーキテクチャ

### Before (v0.2.x)

live-server を使用していた構成の問題点:

- live-server は「ブラックボックス」であり、リロード方法を制御できない
- vimd の watcher と live-server の watcher が両方動作し、非効率
- 将来のインクリメンタル更新（v0.4.0）の実装が困難

### After (v0.3.0)

```
┌─────────────────────────────────────────────────────────────┐
│                        vimd dev                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐                         │
│  │   Watcher   │───▶│  Converter  │                         │
│  │  (chokidar) │    │ (純粋なHTML) │                         │
│  └─────────────┘    └──────┬──────┘                         │
│                            │                                 │
│                            ▼                                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  WebSocketServer                       │  │
│  │  ┌─────────────────┐    ┌─────────────────────────┐   │  │
│  │  │   HTTP Server   │    │    WebSocket Server     │   │  │
│  │  │  (polka + sirv) │    │         (ws)            │   │  │
│  │  │                 │    │                         │   │  │
│  │  │ HTML配信時に     │    │  reload メッセージ送信  │   │  │
│  │  │ スクリプト注入   │    │                         │   │  │
│  │  └─────────────────┘    └─────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │    Browser    │
                    │  (WebSocket)  │
                    └───────────────┘
```

## 技術詳細

### WebSocketServer クラス

`src/core/websocket-server.ts` に実装:

| メソッド | 説明 |
|---------|------|
| `start()` | HTTP + WebSocket サーバーを起動 |
| `stop()` | サーバーを停止 |
| `broadcast(type)` | 全クライアントにメッセージを送信 |

### リロードスクリプト注入

HTML ファイル配信時に、`</body>` タグの前にリロードスクリプトを自動注入:

1. polka ミドルウェアで `.html` リクエストを検出
2. sirv で静的ファイルを取得
3. `</body>` の前にスクリプトを挿入
4. Content-Length ヘッダーを再計算

### 依存関係の変更

| 追加 | 削除 |
|------|------|
| `ws` (WebSocket サーバー) | `live-server` |
| `polka` (HTTP サーバー) | |
| `sirv` (静的ファイル配信) | |

### 新しい依存関係の選定理由

| パッケージ | 理由 |
|-----------|------|
| `ws` | Node.js の標準的な WebSocket ライブラリ、軽量で高速 |
| `polka` | Express 互換で超軽量な HTTP フレームワーク |
| `sirv` | polka と同じ作者、静的ファイル配信に特化、高速 |

## 後方互換性

- CLI オプションは変更なし
- 設定ファイルは変更なし
- ユーザーへの影響なし
- 既存のワークフローがそのまま動作
