# v0.3.0 - WebSocket Direct Communication

English | [日本語](../../ja/releases/v0.3.0.md)

## Overview

vimd v0.3.0 removes the live-server dependency and implements direct WebSocket communication.
This reduces the bundle size by 83% and provides flexible reload control.

## Benchmark

### Environment

- Platform: darwin arm64
- Node.js: v20.19.5
- Iterations: 10 (averaged)

### Server Performance

| Metric | Average | Min | Max |
|--------|---------|-----|-----|
| Server Startup | 1.31ms | 0.23ms | 9.38ms |
| Broadcast Latency | 0.01ms | 0.00ms | 0.04ms |

### Bundle Size Comparison

| Package | Size |
|---------|------|
| live-server (v0.2.x) | 1.7MB |
| ws + polka + sirv (v0.3.0) | 284KB |
| **Reduction** | **-83%** |

### Analysis

- Server startup time averages 1.31ms, extremely fast
- Broadcast latency is 0.01ms, essentially zero
- Bundle size reduced from 1.7MB to 284KB (83% reduction)
- Contributes to faster npm install times and reduced disk usage

## Architecture

### Before (v0.2.x)

Issues with the live-server-based architecture:

- live-server is a "black box" with no control over reload behavior
- Both vimd's watcher and live-server's watcher run simultaneously, inefficient
- Difficult to implement future incremental updates (v0.4.0)

### After (v0.3.0)

```
┌─────────────────────────────────────────────────────────────┐
│                        vimd dev                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐                         │
│  │   Watcher   │───▶│  Converter  │                         │
│  │  (chokidar) │    │ (pure HTML)  │                         │
│  └─────────────┘    └──────┬──────┘                         │
│                            │                                 │
│                            ▼                                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  WebSocketServer                       │  │
│  │  ┌─────────────────┐    ┌─────────────────────────┐   │  │
│  │  │   HTTP Server   │    │    WebSocket Server     │   │  │
│  │  │  (polka + sirv) │    │         (ws)            │   │  │
│  │  │                 │    │                         │   │  │
│  │  │ Inject script   │    │  Send reload message    │   │  │
│  │  │ on HTML delivery │    │                         │   │  │
│  │  └─────────────────┘    └─────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │    Browser    │
                    │  (WebSocket)  │
                    └───────────────┘
```

## Technical Details

### WebSocketServer Class

Implemented in `src/core/websocket-server.ts`:

| Method | Description |
|--------|-------------|
| `start()` | Start HTTP + WebSocket server |
| `stop()` | Stop the server |
| `broadcast(type)` | Send message to all clients |

### Reload Script Injection

When serving HTML files, a reload script is automatically injected before the `</body>` tag:

1. polka middleware detects `.html` requests
2. sirv retrieves the static file
3. Script is inserted before `</body>`
4. Content-Length header is recalculated

### Dependency Changes

| Added | Removed |
|-------|---------|
| `ws` (WebSocket server) | `live-server` |
| `polka` (HTTP server) | |
| `sirv` (static file serving) | |

### Rationale for New Dependencies

| Package | Reason |
|---------|--------|
| `ws` | Standard WebSocket library for Node.js, lightweight and fast |
| `polka` | Express-compatible, ultra-lightweight HTTP framework |
| `sirv` | Same author as polka, specialized for static file serving, fast |

## Backward Compatibility

- No changes to CLI options
- No changes to configuration files
- No impact to users
- Existing workflows continue to work
